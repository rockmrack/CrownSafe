name: Test Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    
    env:
      PYTHONPATH: ${{ github.workspace }}
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Force PostgreSQL to use postgres user globally
      run: |
        echo "PGUSER=postgres" >> $GITHUB_ENV
        echo "PGPASSWORD=postgres" >> $GITHUB_ENV
        echo "PGDATABASE=test_db" >> $GITHUB_ENV
        echo "PGHOST=localhost" >> $GITHUB_ENV
        echo "PGPORT=5432" >> $GITHUB_ENV
        echo "PostgreSQL environment variables set globally"
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Set up Python path
      run: |
        echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
        echo "Python path set to: ${{ github.workspace }}"
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('config/requirements/*.txt', 'tests/*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install packaging first with its dependencies (no upper bound)
        pip install 'packaging>=22.0'
        pip install -r config/requirements/requirements.txt
        pip install -r tests/requirements-test.txt
        # Verify packaging version using proper version comparison
        python -c "from packaging import version; import packaging; assert version.parse(packaging.__version__) >= version.parse('22.0'), f'packaging {packaging.__version__} < 22.0'"
    
    - name: Verify PostgreSQL connection settings
      run: |
        echo "=== PostgreSQL Environment Variables ==="
        echo "PGUSER: $PGUSER"
        echo "PGHOST: $PGHOST"
        echo "PGPORT: $PGPORT"
        echo "PGDATABASE: $PGDATABASE"
        echo "DATABASE_URL: ${DATABASE_URL:-not set}"
        echo ""
        echo "=== Testing PostgreSQL connection ==="
        python -c "
import os
print(f'Python sees PGUSER: {os.environ.get(\"PGUSER\", \"NOT SET\")}')
print(f'Python sees DATABASE_URL: {os.environ.get(\"DATABASE_URL\", \"NOT SET\")}')
print(f'Current user from OS: {os.environ.get(\"USER\", \"NOT SET\")}')
"
        echo "=== PostgreSQL connection test complete ==="
    
    - name: Verify critical imports
      run: |
        # CRITICAL: Set PYTHONPATH cleanly without duplication
        # The workspace path is already in PYTHONPATH from GitHub env
        export PYTHONPATH="${{ github.workspace }}"
        
        # Debug environment first
        echo "Current directory: $(pwd)"
        echo "PYTHONPATH: $PYTHONPATH"
        echo "core_infra directory:"
        ls -la core_infra/ || echo "core_infra not found"
        
        # Test critical imports with better error handling
        python -c "from core_infra.cache_manager import get_cache_stats; print('✅ Critical imports working')" || {
          echo "❌ Import failed! Full debug info:"
          echo "Complete Python path:"
          python -c "import sys; print('\\n'.join(sys.path))"
          echo ""
          echo "Attempting direct import debug:"
          python -c "import sys; import os; print(f'CWD: {os.getcwd()}'); print(f'File exists: {os.path.exists(\"core_infra/cache_manager.py\")}')" || true
          echo "⚠️ Import verification failed but continuing..."
        }
    
    - name: Run unit tests with coverage
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test_secret_key_for_ci
        PYTHONPATH: ${{ github.workspace }}
        DISABLE_REDIS_WARNING: true
        PGUSER: postgres
        PGPASSWORD: postgres
        PGDATABASE: test_db
      run: |
        # Set clean PYTHONPATH without duplication
        export PYTHONPATH="${{ github.workspace }}"
        echo "Running tests with PYTHONPATH=$PYTHONPATH"
        pytest tests/unit/ \
          -v \
          --cov=. \
          --cov-report=xml \
          --cov-report=term-missing \
          -m unit
    
    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test_secret_key_for_ci
        PYTHONPATH: ${{ github.workspace }}
        DISABLE_REDIS_WARNING: true
        PGUSER: postgres
        PGPASSWORD: postgres
        PGDATABASE: test_db
      run: |
        # Set clean PYTHONPATH
        export PYTHONPATH="${{ github.workspace }}"
        pytest tests/integration/ \
          -v \
          --cov=. \
          --cov-append \
          --cov-report=xml \
          --cov-report=term-missing \
          -m integration
    
    - name: Run security tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        SECRET_KEY: test_secret_key_for_ci
        PYTHONPATH: ${{ github.workspace }}
        DISABLE_REDIS_WARNING: true
        PGUSER: postgres
        PGPASSWORD: postgres
        PGDATABASE: test_db
      run: |
        # Set clean PYTHONPATH
        export PYTHONPATH="${{ github.workspace }}"
        pytest tests/security/ \
          -v \
          -m security
    
    - name: Run performance benchmarks
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        SECRET_KEY: test_secret_key_for_ci
        PYTHONPATH: ${{ github.workspace }}
        DISABLE_REDIS_WARNING: true
        PGUSER: postgres
        PGPASSWORD: postgres
        PGDATABASE: test_db
      run: |
        # Set clean PYTHONPATH
        export PYTHONPATH="${{ github.workspace }}"
        pytest tests/performance/ \
          -v \
          --benchmark-only \
          -m performance
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Generate coverage badge
      if: github.ref == 'refs/heads/main'
      run: |
        pip install coverage-badge
        coverage-badge -o coverage.svg -f
    
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ github.token }}
        MINIMUM_GREEN: 80
        MINIMUM_ORANGE: 70

