{% from "macros/logo.html" import render_logo %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    @page {
      size: A4 portrait;
      margin: 0.8in;
      @frame footer_frame {
        -pdf-frame-content: footer_content;
        left: 0.8in; width: 6.7in; bottom: 0.4in; height: 0.5in;
      }
    }
    body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 10pt; color: #242729; }
    h1 { color: #1a237e; font-size: 18pt; border-bottom: 1px solid #2980b9; margin-top: 1.2em; margin-bottom: 0.6em; }
    h2 { color: #2980b9; font-size: 14pt; margin-top: 1.0em; margin-bottom: 0.4em; }
    th { background-color: #e8f0fe; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
    th, td { border: 1px solid #d0d6db; padding: 7px; text-align: left; word-break: break-word; }
    .header { text-align:center; margin-top:40px; margin-bottom:10px; }
    .meta { font-size:10pt; margin-bottom:6px; }
    .subtle { font-size:9.5pt; color:#657384; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 10px; font-size: 9pt; margin-left: 8px; }
    .risk-LOW { background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; }
    .risk-MEDIUM { background:#fff8e1; color:#f9a825; border:1px solid #ffecb3; }
    .risk-HIGH { background:#ffebee; color:#c62828; border:1px solid #ffcdd2; }
    .risk-CRITICAL { background:#ffdde0; color:#b71c1c; border:1px solid #ef9a9a; }
  </style>
  <title>BabyShield Product Safety Report</title>
  </head>
<body>
  <div class="header">
    {% if logo_path %}<img src="{{ logo_path }}" width="160" style="margin-bottom:12px;" />{% endif %}
    <h1>BabyShield Product Safety Report</h1>
    <div class="subtle">Generated by {{ company_name }} • {{ report_date }} • Workflow {{ workflow_id }}</div>
  </div>

  <h2>Product</h2>
  <table>
    <tbody>
      <tr><th style="width:35%">Product Name</th><td>{{ product.product_name or 'N/A' }}</td></tr>
      <tr><th>Brand</th><td>{{ product.brand or 'N/A' }}</td></tr>
      <tr><th>UPC/GTIN</th><td>{{ product.upc_gtin or 'N/A' }}</td></tr>
      <tr><th>Model Number</th><td>{{ product.model_number or 'N/A' }}</td></tr>
      <tr><th>Lot / Serial</th><td>{{ product.lot_or_serial or 'N/A' }}</td></tr>
    </tbody>
  </table>

  <h2>Overall Risk Assessment <span class="pill risk-{{ risk.level }}">{{ risk.level }}</span></h2>
  <table>
    <tbody>
      <tr><th style="width:35%">Risk Score</th><td>{{ risk.score }}/100</td></tr>
      <tr><th>Final Assessment</th><td>{{ risk.final_assessment }}</td></tr>
      <tr><th>Executive Summary</th><td>{{ risk.summary }}</td></tr>
    </tbody>
  </table>
  
  {% if show_critical_warning %}
  <div style="background:#ffebee;border:2px solid #c62828;padding:10px;margin:10px 0;border-radius:5px;">
    <strong style="color:#c62828;">⚠️ CRITICAL SAFETY NOTICE:</strong> This product has been identified as HIGH or CRITICAL risk. 
    Please discontinue use immediately and follow the remedy instructions below.
  </div>
  {% endif %}

  <h2>Data Sources Checked</h2>
  <table>
    <tbody>
      <tr>
        <th style="width:35%">Official Agencies Verified</th>
        <td>{{ data_sources_checked|join(', ') }}</td>
      </tr>
      <tr>
        <th>Check Timestamp</th>
        <td>{{ report_date }}</td>
      </tr>
    </tbody>
  </table>

  <h2>Official Recall Status</h2>
  {% if show_recall_details %}
  <table>
    <thead><tr><th>ID</th><th>Agency</th><th>Date</th><th>Hazard</th><th>Remedy</th><th>Match</th></tr></thead>
    <tbody>
      {% for r in recalls %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.agency }}</td>
        <td>{{ r.date }}</td>
        <td>{{ r.hazard }}</td>
        <td>{{ r.remedy }}</td>
        <td>{{ (r.match_confidence * 100) | round(0) }}% ({{ r.match_type }})</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No official recalls found as of {{ report_date }}.</p>
  {% endif %}

  <h2>Personalized Safety</h2>
  <table>
    <tbody>
      <tr><th style="width:35%">Pregnancy Safety</th><td>{{ personalized.pregnancy_status or 'Not Applicable' }}</td></tr>
      <tr><th>Allergy Check</th><td>{{ personalized.allergy_status or 'No Allergens Detected' }}</td></tr>
      <tr><th>Notes</th><td>{{ personalized.notes or '-' }}</td></tr>
    </tbody>
  </table>

  <h2>Community & Incident Signals</h2>
  <table>
    <tbody>
      <tr><th style="width:35%">Recent Incidents (category)</th><td>{{ community.incident_count or 0 }}</td></tr>
      <tr><th>Community Sentiment</th><td>{{ community.sentiment or 'Neutral' }}</td></tr>
      <tr><th>Summary</th><td>{{ community.summary or 'No unusual activity detected.' }}</td></tr>
    </tbody>
  </table>

  <h2>Manufacturer Compliance Profile</h2>
  <table>
    <tbody>
      <tr><th style="width:35%">Manufacturer</th><td>{{ manufacturer.name or product.brand or 'N/A' }}</td></tr>
      <tr><th>Compliance Score</th><td>{{ manufacturer.compliance_score or 100 }}/100</td></tr>
      <tr><th>Recall History (5y)</th><td>{{ manufacturer.recall_history or 'None recorded' }}</td></tr>
    </tbody>
  </table>

  <h2>Legal Disclaimers</h2>
  <div class="subtle">
    <ol>
      {% for d in disclaimers %}
      <li>{{ d }}</li>
      {% endfor %}
    </ol>
  </div>

  {% if qr_path %}
  <div style="text-align:center;margin-top:18px;">
    <img src="{{ qr_path }}" width="120" alt="QR Code" />
    <div class="subtle" style="margin-top:8px;">
      Scan to view live report online<br/>
      Share with partner or pediatrician
    </div>
  </div>
  {% endif %}

  <div id="footer_content" style="text-align:center; font-size:9pt; color:#808080;">
    Page <pdf:pagenumber /> of <pdf:pagecount /> | BabyShield by {{ company_name }}
  </div>
</body>
</html>

